name: Move release file into releases folder

on:
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  move_release_file:
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v3
        with:
          persist-credentials: true # Allows push back to the repo

      - name: Set up environment variables (timestamp, file paths)
        id: setvars
        run: |
          TIMESTAMP=$(date +'%Y%m%d%H%M%S')
          echo "TIMESTAMP=$TIMESTAMP" >> $GITHUB_ENV
          echo "RELEASE_SOURCE_FILE=release.toml" >> $GITHUB_ENV
          echo "RELEASE_FOLDER=releases" >> $GITHUB_ENV
          echo "RELEASE_TARGET_FILE=release_${TIMESTAMP}.toml" >> $GITHUB_ENV

      - name: Move file to releases folder
        run: |
          echo "Using TIMESTAMP=$TIMESTAMP"
          echo "Copying $RELEASE_SOURCE_FILE to $RELEASE_FOLDER/$RELEASE_TARGET_FILE"
          mkdir -p "$RELEASE_FOLDER"
          mv "$RELEASE_SOURCE_FILE" "$RELEASE_FOLDER/$RELEASE_TARGET_FILE"

      - name: Commit and push changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add "$RELEASE_FOLDER/$RELEASE_TARGET_FILE"
          git commit -m "Add new release file $RELEASE_TARGET_FILE"
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # So we can use $TIMESTAMP, $RELEASE_FOLDER, and $RELEASE_TARGET_FILE again
          TIMESTAMP: ${{ env.TIMESTAMP }}
          RELEASE_FOLDER: ${{ env.RELEASE_FOLDER }}
          RELEASE_TARGET_FILE: ${{ env.RELEASE_TARGET_FILE }}
